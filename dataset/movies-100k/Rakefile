require 'rake/task'
require 'dataset'
require 'pry'

load 'elasticsearch-rake-tasks.rake'

BASE_DIR = File.dirname(__FILE__)
DATASET_FILE = 'movies.zip'

def tmp_dir
  File.join(Dir.tmpdir, 'movies100k')
end

def dataset_exists?
  if File.directory?(tmp_dir)
    File.file?(File.join(tmp_dir, DATASET_FILE))
  else
    false
  end
rescue
  false
end

def download_dataset(url)
  unless File.directory?(tmp_dir)
    puts "Creating directory: #{tmp_dir}"
    Dir.mkdir(tmp_dir)
  end

  Dir.chdir(tmp_dir) do
    sh %{curl -X GET '#{url}' > #{DATASET_FILE}}
    sh %{unzip #{DATASET_FILE}}
  end
end

desc "Download the movies 100k dataset and extracts it"
task :download do
  URL = "http://files.grouplens.org/datasets/movielens/ml-100k.zip"
  unless dataset_exists?
    download_dataset URL
  else
    puts "Dataset already downloaded"
  end
end

desc "Creates the seed file out of the dataset"
task :create_data_set => [:download] do
  dataset_dir = File.join(tmp_dir, 'ml-100k')

  # just create seed file from dataset
  loader = Example::DataSetLoader.new(dataset_dir)
  loader.create_movie_seed_file('u.item', 'item_seed.json')
end
